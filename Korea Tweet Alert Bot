import os
import tweepy
import smtplib
from email.mime.text import MIMEText
from datetime import datetime, timedelta

# Twitter API setup
BEARER_TOKEN = os.getenv("TWITTER_BEARER_TOKEN")
client = tweepy.Client(bearer_token=BEARER_TOKEN)

# Email configuration
SMTP_SERVER = "smtp.gmail.com"
SMTP_PORT = 587
EMAIL_USER = os.getenv("EMAIL_USER")
EMAIL_PASS = os.getenv("EMAIL_PASS")
EMAIL_TO = "taehwan.kim@kdis.ac.kr"

# List of senator X usernames
usernames = [
    "SenatorBaldwin", "SenJohnBarrasso", "SenatorBennet", "MarshaBlackburn", "SenBlumenthal",
    "CoryBooker", "JohnBoozman", "SenatorBraun", "SenKatieBritt", "SenSherrodBrown", "SenTedBudd",
    "SenButler", "SenatorCantwell", "SenCapito", "SenatorCardin", "SenatorCarper", "SenBobCasey",
    "BillCassidy", "SenatorCollins", "ChrisCoons", "JohnCornyn", "SenCortezMasto", "SenTomCotton",
    "SenKevinCramer", "MikeCrapo", "SenTedCruz", "SteveDaines", "SenDuckworth", "SenatorDurbin",
    "SenJoniErnst", "SenFettermanPA", "SenatorFischer", "gillibrandny", "LindseyGrahamSC",
    "ChuckGrassley", "SenatorHagerty", "SenatorHassan", "HawleyMO", "MartinHeinrich",
    "SenatorHick", "maziehirono", "SenJohnHoeven", "SenHydeSmith", "SenRonJohnson", "timkaine",
    "SenMarkKelly", "SenJohnKennedy", "SenAngusKing", "amyklobuchar", "SenatorLankford",
    "SenMikeLee", "SenatorLujan", "SenLummis", "Sen_JoeManchin", "SenMarkey",
    "RogerMarshallMD", "LeaderMcConnell", "SenatorMenendez", "SenJeffMerkley", "JerryMoran",
    "SenMullin", "lisamurkowski", "ChrisMurphyCT", "PattyMurray", "SenOssoff",
    "SenAlexPadilla", "RandPaul", "SenGaryPeters", "SenJackReed", "SenatorRicketts",
    "SenatorRisch", "SenatorRomney", "SenJackyRosen", "SenatorRounds", "marcorubio",
    "SenSanders", "brianschatz", "Eric_Schmitt", "SenSchumer", "SenRickScott",
    "SenatorTimScott", "SenatorShaheen", "SenatorSinema", "SenTinaSmith", "SenStabenow",
    "SenDanSullivan", "SenatorTester", "SenJohnThune", "SenThomTillis", "SenTuberville",
    "ChrisVanHollen", "JDVance1", "MarkWarner", "SenatorWarnock", "SenWarren",
    "PeterWelch", "SenWhitehouse", "SenatorWicker", "RonWyden", "SenToddYoung"
]

def send_email(body):
    msg = MIMEText(body, "plain")
    msg["Subject"] = "Daily Korea Tweets Digest"
    msg["From"] = EMAIL_USER
    msg["To"] = EMAIL_TO

    with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as server:
        server.starttls()
        server.login(EMAIL_USER, EMAIL_PASS)
        server.sendmail(EMAIL_USER, EMAIL_TO, msg.as_string())

def get_korea_tweets():
    keyword = "Korea"
    now = datetime.utcnow()
    weekday = now.weekday()  # Monday = 0
    hours_back = 100 if weekday == 0 else 24
    since = now - timedelta(hours=hours_back)
    result = []

    for username in usernames:
        try:
            user = client.get_user(username=username).data
            tweets = client.get_users_tweets(id=user.id, max_results=10, tweet_fields=["created_at"])
            if tweets and tweets.data:
                for tweet in tweets.data:
                    if tweet.created_at >= since and keyword.lower() in tweet.text.lower():
                        url = f"https://x.com/{username}/status/{tweet.id}"
                        result.append(f"{username}: {tweet.text}\n{url}\n")
        except Exception as e:
            result.append(f"Error with {username}: {e}\n")

    return "\n".join(result) if result else "No relevant tweets found."

if __name__ == "__main__":
    body = get_korea_tweets()
    send_email(body)
